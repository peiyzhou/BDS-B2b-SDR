% /*****************************************************************************
% * Description : obtains the slant ionospheric delay in B1C using BDGIM ionospheric model
% * Parameters  :
% *      NonBrdIonData* nonBrdData   I    BDGIM Non-Broadcast Ionospheric Parameters
% *      BrdIonData* brdData         I    BDGIM Broadcast Ionospheric Parameters
% *	   double mjd			       I	current epoch
% *	   double* sta_xyz		       I	station x,y,z
% *	   double* sat_xyz		       I	satellite x,y,z
% *	   double* brdPara		       I	broadcast ionospheric parameters [const: 9 parameters model]
% *	   double* ion_delay	       O	ionospheric delay in B1C [m]
% *****************************************************************************/
function ion_delay = IonBdsBrdModel(mjd, sta_xyz, sat_xyz, brdPara,freq,Init_mjd)

BRDPARANUM  =    9            ;%     // Number of broadcast ionospheric parameters
PERIODNUM   =   13           ;%      // Number of forecast period for every non-broadcast parameters
TRISERINUM  =  (PERIODNUM*2-1)  ;%   // Trigonometric series number 
NONBRDNUM   =   17            ;%     // Number of non-broadcast one group

nonBrdData = struct('degOrd', zeros(NONBRDNUM, 2), 'perdTable', zeros(NONBRDNUM, TRISERINUM), 'nonBrdCoef', zeros(NONBRDNUM, 12), 'omiga', zeros(1, 12));
brdData = struct('degOrd', zeros(BRDPARANUM, 2), 'brdIonCoef', zeros(1, BRDPARANUM));

NonBrdPara_table = [
    -0.610000, -0.510000, 0.230000, -0.060000, 0.020000, 0.010000, 0.000000, -0.010000, -0.000000, 0.000000, 0.010000, -0.190000, -0.090000, -0.180000, 0.150000, 1.090000, 0.500000, -0.340000, 0.000000, -0.130000, 0.050000, -0.060000, 0.030000, -0.030000, 0.040000;
    -1.310000, -0.430000, -0.200000, -0.050000, -0.080000, -0.030000, -0.020000, 0.000000, -0.020000, 0.000000, 0.000000, -0.020000, 0.070000, 0.060000, -0.310000, -0.140000, -0.080000, -0.090000, -0.110000, 0.070000, 0.030000, 0.130000, -0.020000, 0.080000, -0.020000;
    -2.000000, 0.340000, -0.310000, 0.060000, -0.060000, 0.010000, -0.030000, 0.010000, 0.010000, 0.030000, 0.000000, 0.120000, 0.030000, -0.550000, 0.130000, -0.210000, -0.380000, -1.220000, -0.220000, -0.370000, 0.070000, -0.070000, 0.040000, -0.010000, -0.040000;
    -0.030000, -0.010000, 0.160000, 0.170000, -0.110000, -0.010000, -0.050000, -0.000000, 0.000000, 0.010000, 0.010000, -0.100000, 0.060000, -0.020000, 0.050000, 0.520000, 0.360000, 0.050000, 0.010000, 0.050000, 0.020000, 0.030000, -0.010000, 0.040000, -0.000000;
    0.150000, 0.170000, -0.030000, 0.150000, 0.150000, 0.050000, -0.010000, 0.010000, -0.010000, 0.020000, -0.000000, 0.060000, 0.090000, 0.090000, -0.090000, 0.270000, 0.140000, 0.150000, 0.020000, 0.060000, -0.010000, 0.020000, -0.030000, 0.010000, -0.010000;
    -0.480000, 0.020000, 0.020000, 0.000000, -0.140000, -0.030000, -0.070000, -0.000000, 0.010000, 0.010000, 0.000000, 0.000000, 0.010000, -0.080000, -0.030000, -0.000000, 0.040000, -0.290000, -0.030000, -0.110000, 0.030000, -0.050000, 0.020000, -0.020000, 0.000000;
    -0.400000, -0.060000, 0.040000, 0.110000, 0.010000, 0.050000, -0.030000, -0.010000, -0.000000, 0.000000, 0.000000, -0.020000, 0.020000, 0.000000, 0.060000, 0.110000, 0.000000, -0.170000, -0.010000, -0.070000, 0.020000, -0.050000, 0.010000, -0.020000, 0.010000;
    2.280000, 0.300000, 0.180000, -0.050000, 0.010000, -0.030000, -0.010000, -0.010000, -0.020000, -0.020000, -0.000000, -0.080000, 0.000000, 0.860000, -0.360000, 0.170000, 0.250000, 1.580000, 0.490000, 0.460000, -0.040000, 0.010000, 0.040000, -0.040000, 0.070000;
    -0.160000, 0.440000, 0.340000, -0.160000, 0.040000, -0.010000, 0.020000, 0.000000, 0.000000, 0.000000, 0.000000, -0.020000, -0.040000, -0.180000, 0.080000, 0.230000, 0.170000, -0.060000, -0.030000, -0.000000, -0.010000, 0.000000, 0.000000, 0.000000, 0.000000;
    -0.210000, -0.280000, 0.450000, 0.020000, -0.140000, -0.000000, -0.010000, 0.000000, 0.000000, 0.000000, 0.000000, -0.070000, -0.020000, -0.050000, 0.050000, 0.350000, 0.270000, -0.150000, -0.020000, -0.040000, -0.010000, 0.000000, 0.000000, 0.000000, 0.000000;
    -0.100000, -0.310000, 0.190000, 0.110000, -0.050000, -0.080000, 0.030000, 0.000000, 0.000000, 0.000000, 0.000000, 0.010000, -0.010000, -0.070000, 0.060000, -0.050000, -0.030000, 0.000000, 0.010000, 0.010000, 0.020000, 0.000000, 0.000000, 0.000000, 0.000000;
    -0.130000, -0.170000, -0.250000, 0.040000, 0.080000, -0.040000, -0.100000, 0.000000, 0.000000, 0.000000, 0.000000, 0.030000, 0.010000, 0.040000, -0.020000, 0.020000, -0.030000, 0.130000, 0.020000, 0.070000, 0.030000, 0.000000, 0.000000, 0.000000, 0.000000;
    0.210000, 0.040000, -0.120000, 0.120000, 0.080000, -0.000000, 0.010000, 0.000000, 0.000000, 0.000000, 0.000000, 0.150000, -0.100000, 0.140000, -0.050000, -0.600000, -0.320000, 0.280000, 0.040000, 0.090000, 0.020000, 0.000000, 0.000000, 0.000000, 0.000000;
    0.680000, 0.390000, 0.180000, 0.070000,-0.010000,-0.020000, 0.050000, 0.000000, 0.000000, 0.000000, 0.000000, 0.060000, 0.000000,-0.030000, 0.060000, 0.020000,-0.100000,-0.080000,-0.040000,-0.050000,-0.040000, 0.000000, 0.000000, 0.000000, 0.000000;
    1.060000,-0.120000, 0.400000, 0.020000, 0.010000,-0.030000,-0.010000, 0.000000, 0.000000, 0.000000, 0.000000,-0.050000,-0.010000, 0.370000,-0.200000, 0.010000, 0.200000, 0.620000, 0.160000, 0.150000,-0.040000, 0.000000, 0.000000, 0.000000, 0.000000;
    0.000000, 0.120000,-0.090000,-0.140000, 0.110000, 0.000000, 0.040000, 0.000000, 0.000000, 0.000000, 0.000000,-0.030000, 0.020000,-0.110000, 0.040000, 0.270000, 0.100000,-0.010000,-0.020000,-0.010000,-0.010000, 0.000000, 0.000000, 0.000000, 0.000000;
    -0.120000,-0.000000, 0.210000,-0.140000,-0.120000,-0.030000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,-0.100000, 0.050000,-0.120000, 0.070000, 0.320000, 0.300000,-0.040000,-0.010000, 0.010000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000;];

NonBrdPara_degord_table = [
    3, 0;
    3, 1;
    3, -1;
    3, 2;
    3, -2;
    3, 3;
    3, -3;
    4, 0;
    4, 1;
    4, -1;
    4, 2;
    4, -2;
    5, 0;
    5, 1;
    5, -1;
    5, 2;
    5, -2
];

BrdPara_degord_table = [
    0, 0;
    1, 0;
    1, 1;
    1, -1;
    2, 0;
    2, 1;
    2, -1;
    2, 2;
    2, -2
];

    % constants from ICD
    Hion_bdgim = 400000; % in units of m

    if norm(sta_xyz)>6378137+Hion_bdgim
        ion_delay=2;
        return;
    end
    % 1: basic parameters
    for num = 1:NONBRDNUM
        nonBrdData.degOrd(num, 1) = NonBrdPara_degord_table(num, 1);
        nonBrdData.degOrd(num, 2) = NonBrdPara_degord_table(num, 2);

        for j = 1:TRISERINUM
            nonBrdData.perdTable(num, j) = NonBrdPara_table(num, j);
        end
    end

    for i = 1:BRDPARANUM
        brdData.degOrd(i, 1) = BrdPara_degord_table(i, 1);
        brdData.degOrd(i, 2) = BrdPara_degord_table(i, 2);

        brdData.brdIonCoef(i) = brdPara(i);
    end
    nonBrdData=SetNonBrdCoefPeriod(nonBrdData);

    % 2: IPP
    [~,ipp_b, ipp_l, ipp_e, sat_ele] = IPPBLH1(sta_xyz, sat_xyz, Hion_bdgim);

    % 3: coordinate transfromation
    [geomag_b, geomag_l] = EFLSFL(mjd, ipp_b, ipp_l, 1, 1);

    % 4: VTEC calcuation
    vtec = VtecBrdSH(nonBrdData, brdData, mjd, geomag_b, geomag_l,Init_mjd);

    % 5: mapping function
    mf = IonMapping(2, ipp_e, sat_ele, Hion_bdgim);

    % 6:  factor
    K = 40.3e16 / (1.0 * (freq ^ 2));

    % 7: STEC
    ion_delay = mf * K * vtec;
end